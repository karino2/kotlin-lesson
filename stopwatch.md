---
title: "ストップウォッチを作ろう"
layout: page
---
[Handlerとタイマー](handler_timer.md)と[日付を扱う、Date入門](date_intro.md)を組み合わせて、
さらに[文字列のフォーマット](string_format.md)というのを組み合わせると
ストップウォッチのようなアプリを作る事が出来ます。

簡単な方針を書いておくので、チャレンジしてみてください。

## 作りたいもの概要

ボタンは二つ、スタートとリセットがある。
スタートは開始している時は一時停止にもなる。

UIとしては、

- 数字を表示するTextView
- スタートボタン
- リセットボタン

の三つとなる。下二つのボタンは横に並べる方がそれっぽいかも？（これは好みで）

TextViewは大きめにしておくと良いでしょう。

## アプリの状態を考える

こういうアプリを考える時には、アプリは何種類の状態があるかを考えておくのが良いでしょう。

1. 一番最初の状態
2. ストップウォッチがスタートして秒数が進んでいく状態
3. ストップウォッチが一時停止している状態

だいたいこの三つの状態を考えれば十分でしょう。
二番目の状態を「スタート状態」と呼ぶ事にします。

## タイマーの設定

タイマーは100 msecごとに呼べば良いでしょう。
タイマーがきたら表示の時間を更新し、スタート状態だったら次のタイマーを設定します。

## 時間の計算

理論上はタイマーは毎回100msecごとに来るのだから表示を100msecずつ進めればいいのだけれど、
タイマーはたまに遅れてやってきたりもするので、このやり方では時間はずれていってしまいます。

より正確には、スタートが押された時点での`Date()`のtimeプロパティを使ってその時点の時間を覚えておいて、
各時間で`Date()`を呼んでスタートからどれけ時間が経過したのかを計算して、そこから文字列を出力するといいでしょう。

まずはmsecを単純にTextViewに表示して、うまく動くのを確認したら次の「表示する文字列の作り方」に挑戦してみてください。

## 表示する文字列の作り方（難しい）

さて、うまい事スタートを押してから何msecが経ったのかを計算出来たとします。
これから、

`03:12 64`

のような表示を作りたい。

分かるのはmsecです。例えば1000msecなら1秒となるので、

`00:01 00`

と表示したい。100msecなら

`00:00 10`

です。

5900msecなら

`00:59 00`

です。
では6000msecならどうなるでしょうか？以下のようになる？

`00:60 00`

いえ、普通はストップウォッチはそうはなりません。（実際にストップウォッチアプリなどで試してみてください）

という事でmsecから以下を計算する必要がありそうです。

- 何分か（秒は切り捨て）
- 何秒か（分は取り除いた残り）
- 何msecか

例えば100000msec、つまり100秒の時は、

- 1分
- 40秒
- 0msec

という事を計算で知る必要がある。

それぞれ関数にしてみましょう。
分をローマ字にするとfunで関数のfunとかぶってしまうので、
名前は英語にしましょう。

minutes, seconds, millisecondsでいいでしょう。

### minutes関数を作る

何分かを計算する方法を考えます。
100秒なら1分40秒なので1、200秒なら3分20秒なので3となるようにしたい。

```kotlin
0 == minutes(10000)
1 == minutes(100000)
3 == minutes(200000)
4 == minutes(250000)
```

どうやって計算したらいいでしょうか？
ちなみに時間はLongで処理するので引数はLongにしておきます。
returnはIntにした方がいいですがどっちでもいいです。
LongからIntにするのは`toInt()`でいいでしょう。

{% capture minutes_func %}
fun minutes(msec: Long) : Int {
  // ここをどうにかする
  return 0
}

fun main() {
  println(minutes(10000)) // 0になって欲しい
  println(minutes(100000))  // 1になって欲しい
  println(minutes(200000)) // 3になって欲しい
  println(minutes(250000)) // 4になって欲しい
}
{% endcapture %}
{% include kotlin_quote.html body=minutes_func %}

### seconds関数を作る

minutes関数を作ったら、残りの秒数を求める関数を作ります。
100秒なら1分40秒なので40、200秒なら3分20秒なので20となるようにしたい。

方針はいろいろありますが、

- minutes関数で作ったminutesのぶんを引く
- msecは切り捨てる（割る`/`を使えば良さそう）

というのが簡単でしょうか。

{% capture seconds_func %}
fun seconds(msec: Long) : Int {
  // ここをどうにかする
  return 0
}

fun main() {
  println(seconds(500)) // 0になって欲しい
  println(seconds(10000)) // 10になって欲しい
  println(seconds(100000))  // 40になって欲しい
  println(seconds(200000)) // 20になって欲しい
  println(seconds(250000)) // 10になって欲しい
}
{% endcapture %}
{% include kotlin_quote.html body=seconds_func %}

### milliseconds関数を作る

milliseconds関数を作ります。
これはここまで求めたものを全部引いてもいいのだけれど、
割った余り(`%`)を使ってもいいでしょう。

どういう値の時に幾つになって欲しいのかを自分で考えて3種類くらい書いて、
それを計算する方法を考えます。
算数の問題みたいですね。算数苦手だと少しむずかしいかも。
わからんかったら聞いてください。

### 以上の関数を使って時間を表す文字列をとりあえず作る

だいたい以下みたいな感じで、目的の文字列がほぼ出来ると思います。

```kotlin

val someMsec:Long = 1234567

val mins = minutes(someMsec)
val secs = seconds(someMsec)
val msecs = milliseconds(someMsec)

println("${mins}:${secs} ${msecs}")
```

これだと5秒の時に05では無く5になってしまいますが、まずはこれでいいでしょう。

これでTextViewにセットすればでこぼこした感じにはなるけれどストップウォッチが出来ると思います。

### 文字列のフォーマットを使って05とかを処理する

[文字列のフォーマット](string_format.md)の内容を参考に、
分、秒、msecを0でパディングします。

これで完成です。

